<section class="profile-section spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-12 text-center">
                <div class="profile__text">
                    <h2>Profile</h2>
                    <p>View and Update your profile details</p>
                </div>
            </div>
        </div>
        
        <!-- Form để lưu các thông tin khác của người dùng -->
        <form action="/save-profile" method="POST">
            <!-- User Information -->
            <div class="col-lg-12 text-center">
                <div class="profile__details">
                    <!-- Avatar và nút Upload -->
                    <div class="row mt-4 align-items-center justify-content-center">
                        <div class="col-md-4 text-center">
                            <div class="profile__avatar">
                                <img id="avatar" src="/images/{{user.avatar}}" alt="User Avatar" class="img-fluid rounded-circle" onerror="this.onerror=null; this.src='/images/profile.png';">
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="profile__upload">
                                <!-- Form riêng để upload Avatar -->
                                <form id="avatarForm" enctype="multipart/form-data">
                                    <input type="file" name="avatar" accept="image/jpeg, image/png, image/jpg" id="avatarInput" class="form-control d-none" />
                                    <button type="button" id="uploadButton" class="site-btn mt-2">Upload Avatar</button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Các trường thông tin khác -->
                    <div class="form-group bordered-input">
                        <label for="username">Username</label>
                        <input type="text" name="name" id="username" value="{{user.name}}" class="form-control" />
                    </div>

                    <div class="form-group bordered-input">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" value="{{user.email}}" class="form-control" readonly />
                    </div>
                </div>
            </div>

            <!-- Nút lưu thay đổi -->
            <div class="row mt-4">
                <div class="col-lg-12 text-center">
                    <button type="submit" class="save">Save Changes</button>
                </div>
            </div>
        </form>
    </div>
</section>


<script>
    // Lấy các thành phần cần thiết
    const uploadButton = document.getElementById('uploadButton');
    const avatarInput = document.getElementById('avatarInput');
    const avatarForm = document.getElementById('avatarForm');
    const avatarImg = document.getElementById('avatar');

    // Lắng nghe sự kiện click vào nút
    uploadButton.addEventListener('click', () => {
        avatarInput.click(); // Kích hoạt bảng chọn file
    });

    // Xử lý khi người dùng chọn tệp
    avatarInput.addEventListener('change', () => {
    if (avatarInput.files.length > 0) {
        const formData = new FormData();
        formData.append('avatar', avatarInput.files[0]);

        fetch('/upload-avatar', {
            method: 'POST',
            body: formData,
        })
        .then((response) => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('Failed to upload avatar.');
            }
        })
        .then((data) => {
            alert(data.message);
            document.getElementById('avatar').src = data.avatarUrl; // Cập nhật ảnh avatar
        })
        .catch((error) => console.error('Error uploading avatar:', error));
    }
});

document.querySelector('.save').addEventListener('click', (e) => {
    e.preventDefault(); // Ngăn form submit mặc định

    const userId = "{{user._id}}"; // ID người dùng
    const name = document.getElementById('username').value; // Lấy giá trị name
    const avatarPath = document.getElementById('avatar').src.split('/').pop(); // Lấy tên file avatar

    fetch(`/profile`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ name, avatar: avatarPath }),
    })
        .then((response) => response.json())
        .then((data) => {
            if (data.message) {
                alert(data.message); // Thông báo thành công
            }
        })
        .catch((error) => console.error('Error updating user:', error));
});

</script>
