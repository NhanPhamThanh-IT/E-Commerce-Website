{{> header}}

<section class="profile-section py-10 bg-gray-50">
    <div class="container mx-auto p-8 rounded-xl shadow-lg border border-gray-200 bg-white">
        <!-- Profile Header -->
        <div class="text-center mb-12">
            <h2 class="text-3xl font-semibold text-gray-800">Profile</h2>
            <p class="text-lg text-gray-500 mt-2">View and update your profile details</p>
        </div>

        <!-- Profile Form -->
        <form action="/save-profile" method="POST" class="space-y-8" enctype="application/x-www-form-urlencoded"
            id="profileForm">
            <input type="hidden" name="_method" value="PUT" />
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-16">

                <!-- Left Column: Avatar Section -->
                <div class="flex flex-col items-center justify-center bg-gray-100 p-6 rounded-xl shadow-lg h-full">
                    <div class="w-36 h-36 rounded-full overflow-hidden shadow-xl mb-6">
                        <img id="avatar" src="{{#if user.avatar}}/images/{{user.avatar}}
                        {{else if user.image}}{{user.image}}
                        {{else}}/images/profile.png
                        {{/if}}" alt="User Avatar" class="w-full h-full object-cover" />
                    </div>
                    <label for="avatarInput"
                        class="cursor-pointer bg-black text-white px-4 py-2 rounded-md transition hover:bg-gray-700">
                        Upload Avatar
                    </label>
                    <input type="file" name="avatar" accept="image/jpeg, image/png, image/jpg" id="avatarInput"
                        class="hidden" />
                </div>

                <!-- Right Column: User Info Section -->
                <div class="space-y-8">
                    <!-- Name Section -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Username -->
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-800">Username</label>
                            <input type="text" name="username" id="username" value="{{user.username}}"
                                class="w-full p-3 mt-2 border border-gray-300 rounded-md focus:outline-none focus:ring focus:ring-black focus:border-black" />
                        </div>
                        <!-- First Name -->
                        <div>
                            <label for="firstName" class="block text-sm font-medium text-gray-800">First Name</label>
                            <input type="text" name="firstName" id="firstName" value="{{user.firstName}}"
                                class="w-full p-3 mt-2 border border-gray-300 rounded-md focus:outline-none focus:ring focus:ring-black focus:border-black"
                                required />
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Last Name -->
                        <div>
                            <label for="lastName" class="block text-sm font-medium text-gray-800">Last Name</label>
                            <input type="text" name="lastName" id="lastName" value="{{user.lastName}}"
                                class="w-full p-3 mt-2 border border-gray-300 rounded-md focus:outline-none focus:ring focus:ring-black focus:border-black"
                                required />
                        </div>
                        <!-- Gender -->
                        <div>
                            <label for="gender" class="block text-sm font-medium text-gray-800">Gender</label>
                            <select id="gender" name="gender"
                                class="w-full p-3 mt-2 border border-gray-300 rounded-md focus:outline-none focus:ring focus:ring-black focus:border-black">
                                <option value="female" {{#if (eq user.gender 'female' )}}selected{{/if}}>Female</option>
                                <option value="male" {{#if (eq user.gender 'male' )}}selected{{/if}}>Male</option>
                                <option value="other" {{#if (eq user.gender 'other' )}}selected{{/if}}>Other</option>
                            </select>
                        </div>
                    </div>

                    <!-- Date of Birth and Phone Number -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Birth Date -->
                        <div>
                            <label for="birthDate" class="block text-sm font-medium text-gray-800">Birth Date</label>
                            <input type="date" id="birthDate" name="birthDate" value="{{user.birthDate}}"
                                class="w-full p-3 mt-2 border border-gray-300 rounded-md focus:outline-none focus:ring focus:ring-black focus:border-black"
                                required />
                        </div>
                        <!-- Phone -->
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-800">Phone</label>
                            <input type="text" id="phone" name="phone" value="{{user.phone}}"
                                class="w-full p-3 mt-2 border border-gray-300 rounded-md focus:outline-none focus:ring focus:ring-black focus:border-black"
                                required />
                            <p id="phoneError" class="text-red-500 text-sm mt-1 hidden">Please enter a valid phone
                                number (e.g., +1234567890).</p>
                        </div>
                    </div>

                    <!-- Address -->
                    <div class="grid grid-cols-1 gap-8">
                        <div>
                            <label for="address" class="block text-sm font-medium text-gray-800">Address</label>
                            <textarea id="address" name="address" rows="3"
                                class="w-full p-3 mt-2 border border-gray-300 rounded-md focus:outline-none focus:ring focus:ring-black focus:border-black">{{user.address}}</textarea>
                        </div>
                    </div>

                    <!-- Save Changes Button -->
                    <div class="text-right mt-8">
                        <button type="submit"
                            class="bg-black text-white px-8 py-3 rounded-md transition hover:bg-gray-800">Save
                            Changes</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>


<script>
    const uploadButton = document.getElementById('avatarInput');
    const avatarImg = document.getElementById('avatar');

    uploadButton.addEventListener('change', () => {
        if (uploadButton.files.length > 0) {
            const formData = new FormData();
            formData.append('avatar', uploadButton.files[0]);

            fetch('/upload-avatar', {
                method: 'POST',
                body: formData,
            })
                .then((response) => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Failed to upload avatar.');
                    }
                })
                .then((data) => {
                    alert(data.message);
                    avatarImg.src = data.avatarUrl;
                })
                .catch((error) => console.error('Error uploading avatar:', error));
        }
    });

    document.addEventListener('DOMContentLoaded', function () {
        const birthDateInput = document.getElementById('birthDate');
        const phoneInput = document.getElementById('phone');
        const phoneError = document.getElementById('phoneError');

        const today = new Date();
        const maxDateString = today.toISOString().split('T')[0];
        birthDateInput.setAttribute('max', maxDateString);

        function validatePhoneNumber(phone) {
            const phonePattern = /\(?([0-9]{3})\)?([ .-]?)([0-9]{3})\2([0-9]{4})/;
            return phonePattern.test(phone);
        }

        document.getElementById('profileForm').addEventListener('submit', function (event) {
            if (!validatePhoneNumber(phoneInput.value)) {
                phoneError.classList.remove('hidden');
                event.preventDefault();
            } else {
                phoneError.classList.add('hidden');
            }
        });
    });

</script>